@let isCollapsedValue = isCollapsed();
@let currentUserValue = currentUser();
@let isLoggingOutValue = isLoggingOut();
@let navigationItemsValue = navigationItems();

<div class="flex h-screen">
  <!-- Left Navigation Panel -->
  <div [class]="'flex flex-col transition-all duration-300 bg-sidebar-dark relative ' + (isCollapsedValue ? 'w-20' : 'w-64')">
    <!-- Logo and Menu Header -->
    <div class="logo-header">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center space-x-3">
          <img src="assets/logo-circle.png" fetchpriority="high" loading="eager" alt="Slapshot Labs"
            class="logo-image"
            [class.logo-collapsed]="isCollapsedValue" />
          @if (!isCollapsedValue) {
          <div class="flex flex-col logo-text-container">
            <span class="text-custom-primary leading-tight uppercase logo-text-line logo-text-primary">SLAPSHOT</span>
            <span class="text-white leading-tight uppercase logo-text-line logo-text-white">LABS</span>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Collapse Toggle Button - positioned at the edge -->
    <button (click)="toggleCollapse()" class="collapse-button" [attr.aria-label]="isCollapsedValue ? 'Expand menu' : 'Collapse menu'" type="button">
      <span [class]="'material-symbols-rounded transition-transform duration-300 ' + (isCollapsedValue ? 'rotate-180' : '')"
        style="font-size: 20px;">chevron_left</span>
    </button>

    <!-- Navigation Menu -->
    <nav class="flex-1 overflow-y-auto">
      @for (item of navigationItemsValue; track item.path) {
      <div>
        <!-- Main Navigation Item -->
        <a [href]="item.path" matRipple [matRippleColor]="getRippleColor()" (click)="handleNavigationClick($event, item.path, item)"
          (auxclick)="handleNavigationClick($event, item.path, item)" [class.gamesheet]="item.path === '/gamesheet'" [class]="
              'flex items-center w-full py-3 text-sm text-left border-none cursor-pointer no-underline ' +
              (isCollapsedValue ? 'px-2 justify-center' : 'px-4 justify-between') +
              ' ' +
              (isItemActive(item)
                ? 'bg-custom-primary text-white font-semibold active'
                : 'bg-transparent font-medium')
            " [title]="isCollapsedValue ? item.label : ''">
          <div [class]="'flex items-center flex-1 min-w-0 ' + (isCollapsedValue ? 'justify-center' : 'space-x-3')">
            @if (item.icon) {
            <span [class]="'material-symbols-rounded nav-icon flex-shrink-0 ' + (isItemActive(item) ? 'active' : '')" style="font-size: 20px;">
              {{ getMaterialIcon(item.icon) }}
            </span>
            }
            @if (!isCollapsedValue) {
            <span class="truncate nav-item-text">{{ item.label }}</span>
            }
          </div>
          @if (item.children && !isCollapsedValue) {
          <span (click)="handleChevronClick($event, item)" (keyup.enter)="handleChevronClick($event, item)"
            (keyup.space)="handleChevronClick($event, item)" [class]="
                  'material-symbols-rounded transition-transform duration-200 cursor-pointer flex-shrink-0 text-white submenu-chevron'
                " [style.font-size]="'20px'" [style.transform]="item.expanded ? 'rotate(90deg)' : 'rotate(0deg)'" tabindex="0"
            role="button">chevron_right</span>
          }
        </a>

        <!-- Submenu -->
        @if (item.children && item.expanded && !isCollapsedValue) {
        <div class="ml-6 mt-1 border-l border-sidebar-border pl-4">
          @for (child of item.children; track child.path) {
          <a [href]="child.path" matRipple [matRippleColor]="getRippleColor()" (click)="handleNavigationClick($event, child.path)"
            (auxclick)="handleNavigationClick($event, child.path)" [class]="
                    'w-full px-4 py-2 text-sm text-left bg-transparent border-none cursor-pointer submenu-item no-underline ' +
                    (isActive(child.path)
                      ? 'text-white font-semibold active'
                      : 'font-medium')
                  " [style.color]="isActive(child.path) ? 'white' : '#878787'">
            <div class="flex items-center space-x-3">
              @if (child.icon) {
              <span [class]="'material-symbols-rounded submenu-icon ' + (isActive(child.path) ? 'active' : '')" style="font-size: 18px;">
                {{ getMaterialIcon(child.icon) }}
              </span>
              }
              <span class="nav-item-text">{{ child.label }}</span>
            </div>
          </a>
          }
        </div>
        }
      </div>
      }
    </nav>

    <!-- User Profile Section -->
    <div class="px-4 py-4 user-profile-section">
      <div [class]="'flex items-center ' + (isCollapsedValue ? 'justify-center' : 'space-x-3')">
        <!-- User Avatar -->
        <div class="flex-shrink-0">
          <div
            class="user-avatar"
            [matTooltip]="isCollapsedValue ? getUserFullName() : ''"
            [matTooltipDisabled]="!isCollapsedValue"
            [matTooltipPosition]="'right'"
          >
            {{ getUserInitials() }}
          </div>
        </div>
        @if (!isCollapsedValue) {
        <div class="flex-1 min-w-0">
          <div
            class="text-white font-semibold text-sm truncate user-name-link"
            (click)="goToProfile()"
            (keyup.enter)="goToProfile()"
            (keyup.space)="goToProfile()"
            tabindex="0"
            role="button"
            [attr.aria-label]="'Go to profile page'"
            [matTooltipShowDelay]="500"
            [matTooltip]="getUserFullName()"
            [matTooltipPosition]="'right'"
          >
            {{ getUserFullName() }}
          </div>
          <div class="inline-flex items-center gap-1" [class.cursor-help]="getRoleTooltip() !== null" [matTooltip]="getRoleTooltip() ?? ''"
            [matTooltipDisabled]="!getRoleTooltip()" [matTooltipPosition]="'right'">
            <div class="text-gray-400 text-xs">
              {{ currentUserValue?.role_name || 'User' }}
            </div>
            @if (getRoleTooltip()) {
            <span class="material-symbols-rounded text-gray-400 text-xs" style="font-size: 12px;">
              help
            </span>
            }
          </div>
        </div>
        <div class="flex-shrink-0">
          <app-button-loading [isLoading]="isLoggingOutValue" [isDisabled]="isLoggingOutValue" materialIcon="logout" [bg]="'transparent'"
            [color]="'text_white'" [colorhover]="'primary'" [bghover]="'dark_tone2'" [opacity]="1" [opacityhover]="1" [width]="'auto'"
            [rounded]="false" (clicked)="logout()" tooltip="Logout">
          </app-button-loading>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="app-header">
      <div class="app-header-container">
        <!-- Live banner: horizontally scrollable -->
        <div class="live-banner-container">
          <app-live-banner class="live-banner"></app-live-banner>
        </div>
      </div>
    </header>

    <!-- Breadcrumbs - Sticky -->
    <app-breadcrumbs></app-breadcrumbs>

    <!-- Page Content - Scrollable -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto page-content-wrapper">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>
