@let loadingValue = loading();
@let playersValue = players();
@let layoutModeValue = layoutMode();
@let teamIdValue = teamId();
@let pageTitleValue = pageTitle();

<div class="page-content" [appVisibilityMap]="visibilityByRoleMap">

  <!-- Header with Add Button -->
  <div class="players-header">
    <div class="players-header-left">
      <h2>{{ pageTitleValue }}</h2>
    </div>
    <div class="players-header-actions" style="display: flex; gap: 10px; align-items: center;">
      <!-- View Toggle Button -->
      <app-button
        [materialIcon]="layoutModeValue === 'card' ? 'table_rows' : 'grid_view'"
        [bg]="'white'"
        [bghover]="'gray_tone3'"
        [color]="'text_primary'"
        [colorhover]="'primary'"
        [width]="'auto'"
        [rounded]="false"
        [haveContent]="true"
        (clicked)="toggleLayout()"
      >
        {{ layoutModeValue === 'card' ? 'Table View' : 'Card View' }}
      </app-button>

      <div class="add-player-button-wrapper" role-visibility-name="add-player-button" [attr.role-visibility-team-id]="teamIdValue">
        <app-button
          materialIcon="add"
          [bg]="'primary'"
          [bghover]="'primary_dark'"
          [color]="'white'"
          [colorhover]="'white'"
          [opacity]="1"
          [opacityhover]="1"
          [width]="'auto'"
          [rounded]="false"
          [haveContent]="true"
          (clicked)="openAddPlayerModal()"
        >
          Add a Player
        </app-button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loadingValue) {
    <div class="players-loading">
      <div class="loading-text">Loading players...</div>
    </div>
  }

  <!-- Empty State -->
  @if (!loadingValue && playersValue.length === 0) {
    <div class="players-empty">
      <div class="empty-text">No players found.</div>
    </div>
  }

  <!-- Content based on layout mode -->
  @if (!loadingValue && playersValue.length > 0) {
    @if (layoutModeValue === 'card') {
      <!-- Card View -->
      <div class="players-cards-container">
        @for (player of playersValue; track player.id) {
          <div class="player-card">
            <!-- Card Header -->
            <div class="player-card-header">
              <div class="header-left">
                <div class="player-name-row">
                  <div class="player-avatar">
                    {{ getPlayerInitials(player) }}
                  </div>
                  <div class="player-name-group">
                    <div
                      class="player-name player-link"
                      (click)="viewPlayerProfile(player)"
                      (keyup.enter)="viewPlayerProfile(player)"
                      (keyup.space)="viewPlayerProfile(player)"
                      tabindex="0"
                      role="button"
                      [attr.aria-label]="'View ' + player.firstName + ' ' + player.lastName + ' profile'"
                    >{{ player.firstName }} {{ player.lastName }}</div>
                    <div class="player-jersey-row">
                      @if (player.jerseyNumber) {
                        <div class="player-jersey">#{{ player.jerseyNumber }}</div>
                      }
                      @if (player.birthYear) {
                        <div class="player-info-item">
                          <span class="player-info-label">Birth Year:</span>
                          <span class="player-info-value">{{ player.birthYear }}</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
                <div class="player-info-row">
                  <div class="player-info-item">
                    <span class="player-info-label">Position:</span>
                    <span class="player-info-value">{{ player.position }}</span>
                  </div>
                  @if (player.height) {
                    <div class="player-info-item">
                      <span class="player-info-label">Height:</span>
                      <span class="player-info-value">{{ player.height }}</span>
                    </div>
                  }
                  @if (player.weight) {
                    <div class="player-info-item">
                      <span class="player-info-label">Weight:</span>
                      <span class="player-info-value">{{ player.weight }} lbs</span>
                    </div>
                  }
                  @if (player.shoots) {
                    <div class="player-info-item">
                      <span class="player-info-label">Shoots:</span>
                      <span class="player-info-value">{{ player.shoots }}</span>
                    </div>
                  }
                  @if (player.team) {
                    <div class="player-info-item">
                      <span class="player-info-label">Team:</span>
                      <div class="team-name-with-logo">
                        @if (player.teamLogo) {
                          <img [src]="player.teamLogo" [alt]="player.team" class="team-logo-small" />
                        }
                        @if (player.teamId) {
                          <span
                            class="player-info-value team-link"
                            (click)="goToTeamProfile(player.teamId)"
                            (keyup.enter)="goToTeamProfile(player.teamId)"
                            (keyup.space)="goToTeamProfile(player.teamId)"
                            tabindex="0"
                            role="button"
                            [attr.aria-label]="'View ' + player.team + ' profile'"
                          >{{ player.team }}</span>
                        } @else {
                          <span class="player-info-value">{{ player.team }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>

            <!-- Stats Section -->
            <div class="player-stats-section">
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-label">GP</div>
                  <div class="stat-value">{{ player.gamesPlayed || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">G</div>
                  <div class="stat-value">{{ player.goals || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">A</div>
                  <div class="stat-value">{{ player.assists || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">PTS</div>
                  <div class="stat-value stat-value-highlight">{{ player.points || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">SOG</div>
                  <div class="stat-value">{{ player.shotsOnGoal || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">SC</div>
                  <div class="stat-value">{{ player.scoringChances || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">BS</div>
                  <div class="stat-value">{{ player.blockedShots || 0 }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">PD</div>
                  <div class="stat-value">{{ player.penaltiesDrawn || 0 }}</div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="player-card-actions">
              <app-button-route
                [route]="'/teams-and-rosters/players/' + player.id + '/spray-chart'"
                [queryParams]="{ type: 'player' }"
                [bg]="'secondary'"
                [bghover]="'secondary_dark'"
                [color]="'white'"
                [colorhover]="'white'"
                [materialIcon]="'scatter_plot'"
                [haveContent]="true"
                class="action-button"
              >
                Spray Chart
              </app-button-route>
              <app-button-route
                [route]="'/teams-and-rosters/players/' + player.id + '/profile'"
                [bg]="'green'"
                [bghover]="'green_dark'"
                [color]="'white'"
                [colorhover]="'white'"
                [materialIcon]="'visibility'"
                [haveContent]="true"
                class="action-button"
              >
                Profile
              </app-button-route>
              <app-button
                [bg]="'orange'"
                [bghover]="'orange_dark'"
                [color]="'white'"
                [colorhover]="'white'"
                materialIcon="stylus"
                [haveContent]="true"
                (clicked)="editPlayer(player)"
                class="action-button"
                role-visibility-name="edit-action"
              >
                Edit
              </app-button>
              <app-button
                [bg]="'primary'"
                [bghover]="'primary_dark'"
                [color]="'white'"
                [colorhover]="'white'"
                [materialIcon]="'delete'"
                [haveContent]="true"
                (clicked)="deletePlayer(player)"
                class="action-button"
                role-visibility-name="delete-action"
              >
                Delete
              </app-button>
            </div>
          </div>
        }
      </div>
    } @else {
      <!-- Table View -->
      <div class="players-table-container">
        <app-data-table
          [columns]="tableColumns"
          [data]="playersValue"
          [actions]="tableActions"
          [loading]="loadingValue"
          (actionClick)="onActionClick($event)"
          (sort)="onSort($event)"
          emptyMessage="No players found."
        ></app-data-table>
      </div>
    }
  }
</div>
