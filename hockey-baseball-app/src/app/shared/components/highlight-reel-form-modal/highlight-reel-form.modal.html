<div class="highlight-reel-form-modal">
  <h2 mat-dialog-title class="modal-title">
    <span class="material-symbols-rounded title-icon">video_library</span>
    {{ isEditMode ? 'Edit Highlight Reel' : 'Create Highlight Reel' }}
  </h2>

  <mat-dialog-content class="modal-content">
    @if (isLoading) {
      <div class="loading-container flex items-center justify-center">
        <mat-spinner diameter="32"></mat-spinner>
      </div>
    }

    @if (!isLoading) {
      @let gamesValue = games();
      @let selectedEventsValue = selectedEvents();
      <form [formGroup]="form" class="form">
        <div class="form-row">
          <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="true" class="form-field">
            <mat-label class="uppercase text-custom-secondary">Name</mat-label>
            <input matInput formControlName="name" placeholder="Enter reel name" />
          </mat-form-field>
        </div>
        <div class="form-row align-center">
          <mat-form-field [floatLabel]="'always'" [hideRequiredMarker]="true" class="form-field">
            <mat-label class="uppercase text-custom-secondary">Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="3"
              placeholder="Short description"
            ></textarea>
          </mat-form-field>
        </div>
        <div class="flex justify-end">
          <app-button
            [bg]="'transparent'"
            [bghover]="'button_background'"
            [br]="'border'"
            [color]="'primary'"
            [colorhover]="'primary'"
            [opacity]="1"
            [opacityhover]="1"
            [width]="'auto'"
            [rounded]="false"
            [materialIcon]="'add'"
            [haveContent]="true"
            (clicked)="openAddCustomHighlightModal()"
            >
            Add Custom Highlight
          </app-button>
        </div>
        <div class="two-column-layout">
          <!-- Left Column: Games List -->
          <div class="column games-column">
            <mat-accordion>
              @for (game of gamesValue; track game) {
                <mat-expansion-panel (opened)="onPanelOpened(game)">
                  <mat-expansion-panel-header>
                    <mat-panel-title>{{ game.label }}</mat-panel-title>
                  </mat-expansion-panel-header>
                  @if (game.loading) {
                    <div class="py-4 w-full flex items-center justify-center">
                      <mat-spinner diameter="24" class="mx-auto"></mat-spinner>
                    </div>
                  }
                  @if (!game.loading) {
                    <div>
                      @if (game.events.length === 0) {
                        <div class="text-gray-500 px-2 py-2">
                          No events.
                        </div>
                      }
                      @if (game.events.length > 0) {
                        <div class="overflow-x-auto">
                          <table class="w-full border-collapse">
                            <thead class="bg-gray-50 border-b border-gray-200">
                              <tr>
                                <th
                                  class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                  >
                                  Time
                                </th>
                                <th
                                  class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                  >
                                  Team
                                </th>
                                <th
                                  class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                  >
                                  Event
                                </th>
                                <th
                                  class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                  >
                                  Player
                                </th>
                                <th
                                  class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                  >
                                  Description
                                </th>
                              </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                              @for (row of groupedEvents(game); track row) {
                                @if (row.header) {
                                  <tr class="bg-gray-700">
                                    <td class="px-4 py-3 text-xs font-medium text-white" colspan="5">
                                      {{ row.header }}
                                    </td>
                                  </tr>
                                }
                                @if (!row.header && row.ev; as ev) {
                                  <tr
                                    class="transition-colors cursor-pointer hover:bg-gray-100"
                                    (mousedown)="onEventClick(game, ev); $event.preventDefault()"
                                    [class.selected-row]="isEventSelected(ev.id)"
                                    >
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ timeOf(game, ev) }}</td>
                                    <td class="px-4 py-3">
                                      <div class="flex items-center gap-2">
                                        <div
                                          class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0"
                                          >
                                          <img
                                            [src]="getTeamLogoUrl(ev.team_id)"
                                            [alt]="teamNameOf(game, ev)"
                                            class="w-full h-full object-cover"
                                            />
                                        </div>
                                        <span class="text-sm text-gray-900">{{ teamNameOf(game, ev) }}</span>
                                      </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ eventTextOf(ev) }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                      {{ playerNameOf(game, ev) }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ descriptionOf(ev) }}</td>
                                  </tr>
                                }
                              }
                            </tbody>
                          </table>
                        </div>
                      }
                    </div>
                  }
                </mat-expansion-panel>
              }
            </mat-accordion>
          </div>
          <!-- Right Column: Selected Events Table -->
          <div class="column selected-column">
            <div class="selected-events-table">
              @if (selectedEventsValue.length === 0) {
                <div class="empty-state">
                  <span class="material-symbols-rounded">info</span>
                  <p>Click events from the games list to add them here</p>
                </div>
              }
              @if (selectedEventsValue.length > 0) {
                <div class="table-wrapper">
                  <table class="w-full">
                    <thead>
                      <tr class="custom-header">
                        <th class="header-cell drag-handle-header"></th>
                        <th class="header-cell">Name</th>
                        <th class="header-cell">Description</th>
                        <th class="header-cell">Date</th>
                        <th class="header-cell">Period/Time</th>
                        <th class="header-cell text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody cdkDropList (cdkDropListDropped)="onSelectedEventDrop($event)">
                      @for (event of selectedEventsValue; track event) {
                        <tr class="table-row" cdkDrag>
                          <td class="table-cell drag-handle-cell">
                            <span class="material-symbols-rounded drag-handle" cdkDragHandle>drag_indicator</span>
                          </td>
                          <td class="table-cell">{{ event.eventName }}</td>
                          <td class="table-cell">{{ event.description || '-' }}</td>
                          <td class="table-cell">{{ event.date }}</td>
                          <td class="table-cell">{{ event.periodTime }}</td>
                          <td class="table-cell text-center actions-cell">
                            <button
                              mat-icon-button
                              color="warn"
                              (click)="removeSelectedEvent(event.id)"
                              class="remove-button"
                              title="Remove"
                              >
                              <span class="material-symbols-rounded icon-small">delete</span>
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        </div>
      </form>
    }
  </mat-dialog-content>

  <mat-dialog-actions class="modal-actions">
    <app-button
      [bg]="'transparent'"
      [bghover]="'button_background'"
      [br]="'border'"
      [color]="'text_primary'"
      [colorhover]="'text_primary'"
      [opacity]="1"
      [opacityhover]="1"
      [width]="'auto'"
      [rounded]="false"
      [haveContent]="true"
      (clicked)="onCancel()"
      >
      Cancel
    </app-button>
    <app-button-loading
      [isLoading]="false"
      [isDisabled]="form.invalid"
      materialIcon="save"
      [bg]="'primary'"
      [bghover]="'primary_dark'"
      [color]="'white'"
      [colorhover]="'white'"
      [opacity]="1"
      [opacityhover]="1"
      [width]="'auto'"
      [rounded]="false"
      [haveContent]="true"
      (clicked)="onSubmit()"
      >
      {{ isEditMode ? 'Update Highlight Reel' : 'Create Highlight Reel' }}
    </app-button-loading>
  </mat-dialog-actions>
</div>
