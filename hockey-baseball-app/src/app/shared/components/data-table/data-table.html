<div class="data-table-container">
  <!-- Loading State -->
  @if (loading) {
    <div class="loading-state">
      <div class="flex items-center justify-center py-8">
        <mat-spinner diameter="32"></mat-spinner>
        <span class="ml-3 text-custom-secondary">Loading...</span>
      </div>
    </div>
  }

  <!-- Material Table -->
  @if (!loading) {
    <div class="table-wrapper">
      <table
        mat-table
        [dataSource]="data"
        matSort
        (matSortChange)="onSortChange($event)"
        class="mat-elevation-2"
      >
        <!-- Dynamic Columns -->
        @for (column of columns; track column.key) {
          <ng-container [matColumnDef]="column.key">
            <!-- Sortable header -->
            @if (column.sortable) {
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header="{{ column.key }}"
                [style.width]="column.width"
                [class.text-center]="column.align === 'center'"
                [class.text-right]="column.align === 'right'"
              >
                {{ column.label }}
              </th>
            } @else {
              <!-- Non-sortable header -->
              <th
                mat-header-cell
                *matHeaderCellDef
                [style.width]="column.width"
                [class.text-center]="column.align === 'center'"
                [class.text-right]="column.align === 'right'"
              >
                {{ column.label }}
              </th>
            }
            <td
              mat-cell
              *matCellDef="let element"
              #cellElement
              #tooltip="matTooltip"
              [style.width]="column.width"
              [class.text-center]="column.align === 'center'"
              [class.text-right]="column.align === 'right'"
              [class.badge-cell]="
                column.type === 'custom' && (column.key === 'status' || column.key === 'gameType')
              "
              [matTooltip]="getTooltipText(element, column)"
              matTooltipPosition="above"
              [matTooltipDisabled]="column.showTooltip === false"
              (mouseenter)="onCellMouseEnter(cellElement, tooltip, element, column)"
            >
              @switch (column.type) {
                <!-- Text -->
                @case ('text') {
                  @if (column.key === 'playerName' || column.key === 'goalieName') {
                    @if (getCellValueByKey(element, 'id')) {
                      <a
                        [routerLink]="column.key === 'playerName' 
                          ? ['/teams-and-rosters/players/player-profile', getCellValueByKey(element, 'id')]
                          : ['/teams-and-rosters/goalies/goalie-profile', getCellValueByKey(element, 'id')]"
                        class="player-name-link"
                      >
                        {{ getCellValueByKey(element, 'firstName') }} {{ getCellValueByKey(element, 'lastName') }}
                      </a>
                    } @else {
                      <span>
                        {{ getCellValueByKey(element, 'firstName') }} {{ getCellValueByKey(element, 'lastName') }}
                      </span>
                    }
                  } @else if (column.key === 'team') {
                    <div class="team-cell">
                      <div class="team-logo-container">
                        @if (getCellValueByKey(element, 'teamLogo')) {
                          @if (getCellValueByKey(element, 'teamId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, 'teamId')]"
                              class="team-logo-link"
                            >
                              <img
                                [src]="getCellValueByKey(element, 'teamLogo')"
                                [alt]="getCellValue(element, column) || 'Team logo'"
                                class="team-logo"
                              />
                            </a>
                          } @else {
                            <img
                              [src]="getCellValueByKey(element, 'teamLogo')"
                              [alt]="getCellValue(element, column) || 'Team logo'"
                              class="team-logo"
                            />
                          }
                        }
                      </div>
                      <div class="team-content">
                        @if (getCellValueByKey(element, 'teamId')) {
                          <a
                            [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, 'teamId')]"
                            class="team-name-link"
                          >
                            {{ getCellValue(element, column) || '-' }}
                          </a>
                        } @else {
                          <div class="team-name">{{ getCellValue(element, column) || '-' }}</div>
                        }
                        <div class="team-info">
                          {{ getCellValueByKey(element, 'teamAgeGroup') }}
                          {{ getCellValueByKey(element, 'teamLevelName') }}
                        </div>
                      </div>
                    </div>
                  } @else if (column.key === 'homeTeam' || column.key === 'awayTeam') {
                    <div class="team-cell">
                      <div class="team-logo-container">
                        @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')) {
                          @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')]"
                              class="team-logo-link"
                            >
                              <img
                                [src]="getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')"
                                [alt]="getCellValue(element, column) || 'Team logo'"
                                class="team-logo"
                              />
                            </a>
                          } @else {
                            <img
                              [src]="getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')"
                              [alt]="getCellValue(element, column) || 'Team logo'"
                              class="team-logo"
                            />
                          }
                        }
                      </div>
                      <div class="team-content">
                        @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')) {
                          <a
                            [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')]"
                            class="team-name-link"
                          >
                            {{ getCellValue(element, column) || '-' }}
                          </a>
                        } @else {
                          <div class="team-name">{{ getCellValue(element, column) || '-' }}</div>
                        }
                        <div class="team-info">
                          {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamAgeGroup' : 'awayTeamAgeGroup') }}
                          {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLevelName' : 'awayTeamLevelName') }}
                        </div>
                        <div class="team-goalie">
                          Goalie:
                          @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalieId' : 'awayTeamGoalieId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/goalies/goalie-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalieId' : 'awayTeamGoalieId')]"
                              class="goalie-name-link"
                            >
                              {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalie' : 'awayTeamGoalie') || '-' }}
                            </a>
                          } @else {
                            <span>{{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalie' : 'awayTeamGoalie') || '-' }}</span>
                          }
                        </div>
                      </div>
                    </div>
                  } @else {
                    <span>
                      {{ getCellValue(element, column) || '-' }}
                    </span>
                  }
                }

                <!-- Number -->
                @case ('number') {
                  <span [class]="column.key === 'homeGoals' || column.key === 'awayGoals' ? 'font-mono goals-value' : 'font-mono'">
                    @if (column.key === 'birthYear') {
                      {{ getCellValue(element, column) }}
                    } @else {
                      {{ getNumberValue(element, column) | number }}
                    }
                  </span>
                }

                <!-- Date -->
                @case ('date') {
                  <span>
                    {{ getDateValue(element, column) | date: 'MMM. d, y' }}
                  </span>
                }

                <!-- Dropdown -->
                @case ('dropdown') {
                  @if (column.key === 'shoots' || column.key === 'catches') {
                    <span>
                      @if (column.key === 'shoots') {
                        {{ getCellValue(element, column) === 'Right Shot' ? 'R' : getCellValue(element, column) === 'Left Shot' ? 'L' : getCellValue(element, column) || '-' }}
                      } @else {
                        {{ getCellValue(element, column) === 'Right' ? 'R' : getCellValue(element, column) === 'Left' ? 'L' : getCellValue(element, column) || '-' }}
                      }
                    </span>
                  } @else {
                    <span>
                      {{ getCellValue(element, column) || '-' }}
                    </span>
                  }
                }

                <!-- Custom rendering -->
                @case ('custom') {
                  @if (column.key === 'status') {
                    <span [class]="getStatusBadgeClass(getCellValue(element, column))">
                      {{ getCellValueByKey(element, 'statusName') || getStatusLabel(getCellValue(element, column)) }}
                    </span>
                  } @else if (column.key === 'gameType') {
                    <span [class]="getGameTypeBadgeClass(getCellValue(element, column))">
                      {{ getCellValueByKey(element, 'gameTypeName') || getCellValue(element, column) }}
                    </span>
                  } @else {
                    <span>
                      {{ getCellValue(element, column) || '-' }}
                    </span>
                  }
                }

                <!-- Default -->
                @default {
                  @if (column.key === 'playerName' || column.key === 'goalieName') {
                    @if (getCellValueByKey(element, 'id')) {
                      <a
                        [routerLink]="column.key === 'playerName' 
                          ? ['/teams-and-rosters/players/player-profile', getCellValueByKey(element, 'id')]
                          : ['/teams-and-rosters/goalies/goalie-profile', getCellValueByKey(element, 'id')]"
                        class="player-name-link"
                      >
                        {{ getCellValueByKey(element, 'firstName') }} {{ getCellValueByKey(element, 'lastName') }}
                      </a>
                    } @else {
                      <span>
                        {{ getCellValueByKey(element, 'firstName') }} {{ getCellValueByKey(element, 'lastName') }}
                      </span>
                    }
                  } @else if (column.key === 'team') {
                    <div class="team-cell">
                      <div class="team-logo-container">
                        @if (getCellValueByKey(element, 'teamLogo')) {
                          @if (getCellValueByKey(element, 'teamId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, 'teamId')]"
                              class="team-logo-link"
                            >
                              <img
                                [src]="getCellValueByKey(element, 'teamLogo')"
                                [alt]="getCellValue(element, column) || 'Team logo'"
                                class="team-logo"
                              />
                            </a>
                          } @else {
                            <img
                              [src]="getCellValueByKey(element, 'teamLogo')"
                              [alt]="getCellValue(element, column) || 'Team logo'"
                              class="team-logo"
                            />
                          }
                        }
                      </div>
                      <div class="team-content">
                        @if (getCellValueByKey(element, 'teamId')) {
                          <a
                            [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, 'teamId')]"
                            class="team-name-link"
                          >
                            {{ getCellValue(element, column) || '-' }}
                          </a>
                        } @else {
                          <div class="team-name">{{ getCellValue(element, column) || '-' }}</div>
                        }
                        <div class="team-info">
                          {{ getCellValueByKey(element, 'teamAgeGroup') }}
                          {{ getCellValueByKey(element, 'teamLevelName') }}
                        </div>
                      </div>
                    </div>
                  } @else if (column.key === 'arenaRink') {
                    <div class="arena-rink-cell">
                      <div class="arena-rink-name">{{ getCellValue(element, column) || '-' }}</div>
                      @if (getCellValueByKey(element, 'arenaAddress')) {
                        <div class="arena-address">{{ getCellValueByKey(element, 'arenaAddress') }}</div>
                      }
                    </div>
                  } @else if (column.key === 'homeTeam' || column.key === 'awayTeam') {
                    <div class="team-cell">
                      <div class="team-logo-container">
                        @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')) {
                          @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')]"
                              class="team-logo-link"
                            >
                              <img
                                [src]="getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')"
                                [alt]="getCellValue(element, column) || 'Team logo'"
                                class="team-logo"
                              />
                            </a>
                          } @else {
                            <img
                              [src]="getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLogo' : 'awayTeamLogo')"
                              [alt]="getCellValue(element, column) || 'Team logo'"
                              class="team-logo"
                            />
                          }
                        }
                      </div>
                      <div class="team-content">
                        @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')) {
                          <a
                            [routerLink]="['/teams-and-rosters/teams/team-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamId' : 'awayTeamId')]"
                            class="team-name-link"
                          >
                            {{ getCellValue(element, column) || '-' }}
                          </a>
                        } @else {
                          <div class="team-name">{{ getCellValue(element, column) || '-' }}</div>
                        }
                        <div class="team-info">
                          {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamAgeGroup' : 'awayTeamAgeGroup') }}
                          {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamLevelName' : 'awayTeamLevelName') }}
                        </div>
                        <div class="team-goalie">
                          Goalie:
                          @if (getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalieId' : 'awayTeamGoalieId')) {
                            <a
                              [routerLink]="['/teams-and-rosters/goalies/goalie-profile', getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalieId' : 'awayTeamGoalieId')]"
                              class="goalie-name-link"
                            >
                              {{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalie' : 'awayTeamGoalie') || '-' }}
                            </a>
                          } @else {
                            <span>{{ getCellValueByKey(element, column.key === 'homeTeam' ? 'homeTeamGoalie' : 'awayTeamGoalie') || '-' }}</span>
                          }
                        </div>
                      </div>
                    </div>
                  } @else {
                    <span>
                      {{ getCellValue(element, column) || '-' }}
                    </span>
                  }
                }
              }
            </td>
          </ng-container>
        }

        <!-- Actions Column -->
        @if (actions.length > 0) {
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-center" style="width: 300px">
              Actions
            </th>
            <td
              mat-cell
              *matCellDef="let element"
              class="text-center actions-cell"
              style="width: 300px"
            >
              <div class="flex flex-wrap items-center justify-end" style="gap: 15px;">
                @for (action of actions; track action.action) {
                  @if (!action.condition || action.condition(element)) {
                    <app-button-small
                      [materialIcon]="action.icon || getActionIcon(action.action)"
                      [bg]="'transparent'"
                      [bghover]="'transparent'"
                      [color]="getActionColor(action.variant, action.action)"
                      [colorhover]="getActionColorHover(action.variant, action.action)"
                      [tooltip]="action.iconOnly ? action.label : null"
                      [haveContent]="!action.iconOnly"
                      [rounded]="false"
                      (clicked)="onActionClick(action.action, element)"
                      [attr.role-access-name]="action.roleAccessName"
                      [attr.role-visibility-name]="action.roleVisibilityName"
                      [attr.role-visibility-author-id]="
                        action.roleVisibilityAuthorId
                          ? typeof action.roleVisibilityAuthorId === 'function'
                            ? action.roleVisibilityAuthorId(element)
                            : action.roleVisibilityAuthorId
                          : null
                      "
                      [attr.role-visibility-team-id]="
                        action.roleVisibilityTeamId
                          ? typeof action.roleVisibilityTeamId === 'function'
                            ? action.roleVisibilityTeamId(element)
                            : action.roleVisibilityTeamId
                          : null
                      "
                    >
                      @if (!action.iconOnly) {
                        {{ action.label }}
                      }
                    </app-button-small>
                  }
                }
              </div>
            </td>
          </ng-container>
        }

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="custom-header"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
      </table>

      <!-- Empty State -->
      @if (data.length === 0) {
        <div class="empty-state">
          <div class="text-center py-12">
            <div class="text-gray-500">{{ emptyMessage }}</div>
          </div>
        </div>
      }
    </div>
  }
</div>
